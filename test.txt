

import com.nimbusds.jose.jwk.source.RemoteJWKSet;
import com.nimbusds.jose.jwk.source.JWKSource;
import com.nimbusds.jose.proc.SecurityContext;
import com.nimbusds.jose.util.DefaultResourceRetriever;
import org.springframework.security.oauth2.jwt.*;
import java.net.URL;

@Bean
public JwtDecoder jwtDecoder() throws Exception {
    String jwkSetUri = "<your JWK Set URI>";
    String issuer = "<your issuer>";
    String expectedAudience = "<your audience>";

    // Configure timeouts and cache duration (in ms)
    int connectTimeout = 2000;
    int readTimeout = 2000;
    int cacheDuration = 600_000; // 10 minutes

    // Configure resource retriever with caching
    DefaultResourceRetriever resourceRetriever =
            new DefaultResourceRetriever(connectTimeout, readTimeout, cacheDuration);

    // Create a RemoteJWKSet with cache
    JWKSource<SecurityContext> jwkSource =
            new RemoteJWKSet<>(new URL(jwkSetUri), resourceRetriever);

    // Build NimbusJwtDecoder manually using the JWKSource
    NimbusJwtDecoder jwtDecoder = new NimbusJwtDecoder(jwkSource);

    // Add validators
    OAuth2TokenValidator<Jwt> withIssuer = JwtValidators.createDefaultWithIssuer(issuer);
    OAuth2TokenValidator<Jwt> audienceValidator = new AudienceValidator(expectedAudience);
    OAuth2TokenValidator<Jwt> withAudience = new DelegatingOAuth2TokenValidator<>(withIssuer, audienceValidator);
    jwtDecoder.setJwtValidator(withAudience);

    return jwtDecoder;
}
