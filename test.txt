import { Injectable } from '@angular/core';
import { OAuthService } from 'angular-oauth2-oidc';

@Injectable()
export class CustomOAuthService extends OAuthService {

  /**
   * Override the method that exchanges the authorization code for tokens.
   * This lets us inject custom parameters for the /token request.
   */
  protected async fetchTokenUsingGrantCode(code: string): Promise<object> {

    // ✅ Get PKCE verifier dynamically (it's stored in localStorage/sessionStorage)
    const pkceVerifier = sessionStorage.getItem('PKCE_verifier') || localStorage.getItem('PKCE_verifier');

    // ✅ Add your custom parameters here
    const customParams: Record<string, string> = {
      client_id: this.clientId,
      grant_type: 'authorization_code',
      code,
      redirect_uri: this.redirectUri,
      ...(pkceVerifier ? { code_verifier: pkceVerifier } : {}),
      custom_param_1: 'value1',
      custom_param_2: 'value2'
    };

    const body = new URLSearchParams(customParams as any).toString();

    const headers = new Headers({
      'Content-Type': 'application/x-www-form-urlencoded'
    });

    const response = await fetch(this.tokenEndpoint!, {
      method: 'POST',
      body,
      headers
    });

    const tokenResponse = await response.json();
    this.storeAccessTokenResponse(tokenResponse);
    return tokenResponse;
  }
}



import { CustomOAuthService } from './services/custom-oauth.service';

@NgModule({
  providers: [
    { provide: OAuthService, useClass: CustomOAuthService }
  ]
})
export class AppModule {}



bootstrapApplication(AppComponent, {
  providers: [
    { provide: OAuthService, useClass: CustomOAuthService }
  ]
});





