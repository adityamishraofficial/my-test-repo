

import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { OAuthService } from 'angular-oauth2-oidc';
import { lastValueFrom } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class AuthService {
  constructor(private oauthService: OAuthService, private http: HttpClient) {}

  login(): void {
    // Start the redirect to SSO (standard)
    this.oauthService.initCodeFlow();
  }

  async handleRedirectAndExchangeToken(): Promise<void> {
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    if (!code) return;

    console.log('‚úÖ Authorization code received:', code);

    // Stop the default token call by NOT calling tryLoginCodeFlow()
    // Instead, call token endpoint manually:
    const body = new HttpParams({
      fromObject: {
        grant_type: 'authorization_code',
        code,
        redirect_uri: this.oauthService.redirectUri!,
        client_id: this.oauthService.clientId!,
        // üëá your custom params
        custom_param_1: 'value1',
        custom_param_2: 'value2',
        code_verifier: sessionStorage.getItem('PKCE_verifier') || ''
      }
    });

    const tokenUrl = this.oauthService.tokenEndpoint!;
    const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };

    try {
      const response: any = await lastValueFrom(this.http.post(tokenUrl, body, { headers }));

      console.log('%c‚úÖ Custom token exchange successful', 'color:limegreen', response);

      // Let angular-oauth2-oidc manage token lifecycle from now on
      this.oauthService.processIdToken(response);
      this.oauthService.processAccessTokenResponse(response, null);

      // Optional: clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch (err) {
      console.error('‚ùå Custom token request failed', err);
    }
  }
}
