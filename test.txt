

import com.nimbusds.jose.jwk.source.JWKSource;
import com.nimbusds.jose.jwk.source.RemoteJWKSet;
import com.nimbusds.jose.proc.SecurityContext;
import com.nimbusds.jose.util.DefaultResourceRetriever;
import com.nimbusds.jwt.proc.DefaultJWTProcessor;
import org.springframework.security.oauth2.jwt.*;
import org.springframework.security.oauth2.core.*;
import org.springframework.security.oauth2.core.validator.*;
import java.net.URL;

@Bean
public JwtDecoder jwtDecoder() throws Exception {
    String jwkSetUri = "<your JWK Set URI>";
    String issuer = "<your issuer>";
    String expectedAudience = "<your audience>";

    // Timeouts and cache (in ms)
    int connectTimeout = 2000;
    int readTimeout = 2000;
    int cacheDuration = 600_000; // 10 minutes

    // Configure retriever with cache
    DefaultResourceRetriever resourceRetriever =
            new DefaultResourceRetriever(connectTimeout, readTimeout, cacheDuration);

    // Create cached JWK source
    JWKSource<SecurityContext> jwkSource =
            new RemoteJWKSet<>(new URL(jwkSetUri), resourceRetriever);

    // Create Nimbus JWT processor using cached JWK source
    DefaultJWTProcessor<SecurityContext> jwtProcessor = new DefaultJWTProcessor<>();
    jwtProcessor.setJWSKeySelector(
            new com.nimbusds.jose.proc.JWSVerificationKeySelector<>(
                    com.nimbusds.jose.JWSAlgorithm.RS256,
                    jwkSource
            )
    );

    // Build decoder
    NimbusJwtDecoder jwtDecoder = new NimbusJwtDecoder(jwtProcessor);

    // Add validators
    OAuth2TokenValidator<Jwt> withIssuer = JwtValidators.createDefaultWithIssuer(issuer);
    OAuth2TokenValidator<Jwt> audienceValidator = new AudienceValidator(expectedAudience);
    OAuth2TokenValidator<Jwt> withAudience =
            new DelegatingOAuth2TokenValidator<>(withIssuer, audienceValidator);
    jwtDecoder.setJwtValidator(withAudience);

    return jwtDecoder;
}
