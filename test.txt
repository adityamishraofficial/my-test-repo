import { Injectable } from '@angular/core';
import { OAuthService, ParsedIdToken } from 'angular-oauth2-oidc';

@Injectable()
export class CustomOAuthService extends OAuthService {

  protected async fetchTokenUsingGrantCode(code: string): Promise<object> {

    // ✅ Get PKCE verifier dynamically
    const pkceVerifier = sessionStorage.getItem('PKCE_verifier') || localStorage.getItem('PKCE_verifier');

    // ✅ Add your custom parameters
    const customParams: Record<string, string> = {
      client_id: this.clientId,
      grant_type: 'authorization_code',
      code,
      redirect_uri: this.redirectUri,
      ...(pkceVerifier ? { code_verifier: pkceVerifier } : {}),
      custom_param_1: 'value1',
      custom_param_2: 'value2'
    };

    const body = new URLSearchParams(customParams as any).toString();

    const headers = new Headers({
      'Content-Type': 'application/x-www-form-urlencoded'
    });

    // ✅ Perform token request
    const response = await fetch(this.tokenEndpoint!, {
      method: 'POST',
      body,
      headers
    });

    const tokenResponse = await response.json();

    // ✅ Use correct signature for storeAccessTokenResponse
    this.storeAccessTokenResponse(
      tokenResponse.access_token,
      tokenResponse.refresh_token,
      tokenResponse.expires_in,
      tokenResponse.scope
    );

    // ✅ Also handle ID token if returned
    if (tokenResponse.id_token) {
      const parsedIdToken = this.processIdToken(tokenResponse.id_token, tokenResponse.access_token);
      this.storeIdToken(tokenResponse.id_token, parsedIdToken);
    }

    return tokenResponse;
  }
}



import { CustomOAuthService } from './services/custom-oauth.service';

@NgModule({
  providers: [
    { provide: OAuthService, useClass: CustomOAuthService }
  ]
})
export class AppModule {}



bootstrapApplication(AppComponent, {
  providers: [
    { provide: OAuthService, useClass: CustomOAuthService }
  ]
});





